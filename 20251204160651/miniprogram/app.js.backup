App({
  globalData: {
    userInfo: null,
    hasCheckin: false,
    socketStatus: 'disconnected',
    serverUrl: 'https://your-project.up.railway.app', // ğŸ”§ éƒ¨ç½²åæ›¿æ¢ä¸ºä½ çš„Railwayåœ°å€
    employeeInfo: null
  },

  onLaunch() {
    console.log('iLuckå¹´ä¼šå°ç¨‹åºå¯åŠ¨');
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus();
    
    // åˆå§‹åŒ–Socketè¿æ¥
    this.initSocket();
  },

  onShow() {
    // é‡æ–°è¿æ¥Socket
    if (this.globalData.socketStatus === 'disconnected') {
      this.initSocket();
    }
  },

  onHide() {
    // æ–­å¼€Socketè¿æ¥
    if (this.globalData.socket) {
      this.globalData.socket.disconnect();
      this.globalData.socketStatus = 'disconnected';
    }
  },

  checkLoginStatus() {
    const userInfo = wx.getStorageSync('userInfo');
    const employeeInfo = wx.getStorageSync('employeeInfo');
    const hasCheckin = wx.getStorageSync('hasCheckin');
    
    if (userInfo) {
      this.globalData.userInfo = userInfo;
    }
    
    if (employeeInfo) {
      this.globalData.employeeInfo = employeeInfo;
    }
    
    if (hasCheckin) {
      this.globalData.hasCheckin = hasCheckin;
    }
  },

  initSocket() {
    try {
      const socket = require('./utils/socket.io.js');
      const socketInstance = socket(this.globalData.serverUrl);
      
      socketInstance.on('connect', () => {
        console.log('Socketè¿æ¥æˆåŠŸ');
        this.globalData.socketStatus = 'connected';
        this.globalData.socket = socketInstance;
        
        // æ³¨å†Œä¸ºå°ç¨‹åºå®¢æˆ·ç«¯
        socketInstance.emit('register', { 
          type: 'miniprogram',
          userId: this.globalData.employeeInfo?.id || 'anonymous'
        });
      });

      socketInstance.on('disconnect', () => {
        console.log('Socketè¿æ¥æ–­å¼€');
        this.globalData.socketStatus = 'disconnected';
      });

      socketInstance.on('connect_error', (error) => {
        console.error('Socketè¿æ¥é”™è¯¯:', error);
        this.globalData.socketStatus = 'error';
      });

      this.globalData.socket = socketInstance;
    } catch (error) {
      console.error('Socketåˆå§‹åŒ–å¤±è´¥:', error);
      this.globalData.socketStatus = 'error';
    }
  },

  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo() {
    return new Promise((resolve, reject) => {
      if (this.globalData.userInfo) {
        resolve(this.globalData.userInfo);
        return;
      }

      wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™',
        success: (res) => {
          this.globalData.userInfo = res.userInfo;
          wx.setStorageSync('userInfo', res.userInfo);
          resolve(res.userInfo);
        },
        fail: reject
      });
    });
  },

  // è·å–å‘˜å·¥ä¿¡æ¯
  getEmployeeInfo() {
    return this.globalData.employeeInfo;
  },

  // è®¾ç½®å‘˜å·¥ä¿¡æ¯
  setEmployeeInfo(employeeInfo) {
    this.globalData.employeeInfo = employeeInfo;
    wx.setStorageSync('employeeInfo', employeeInfo);
  },

  // è®¾ç½®ç­¾åˆ°çŠ¶æ€
  setCheckinStatus(status) {
    this.globalData.hasCheckin = status;
    wx.setStorageSync('hasCheckin', status);
  },

  // æ˜¾ç¤ºé”™è¯¯æç¤º
  showError(message) {
    wx.showToast({
      title: message,
      icon: 'none',
      duration: 2000
    });
  },

  // æ˜¾ç¤ºæˆåŠŸæç¤º
  showSuccess(message) {
    wx.showToast({
      title: message,
      icon: 'success',
      duration: 2000
    });
  },

  // æ˜¾ç¤ºåŠ è½½ä¸­
  showLoading(title = 'åŠ è½½ä¸­...') {
    wx.showLoading({
      title: title
    });
  },

  // éšè—åŠ è½½ä¸­
  hideLoading() {
    wx.hideLoading();
  }
});